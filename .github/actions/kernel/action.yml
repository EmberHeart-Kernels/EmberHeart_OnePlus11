name: Build Kernel & Modules
description: Builds kernel image and unified modules

inputs:
  op_config_json:
    description: 'JSON string containing full device config'
    required: true
    type: string
  ksun_branch:
    required: true
    type: string
    default: stable
  susfs_commit_hash_or_branch:
    required: false
    type: string
    default: ""
  optimize_level:
    required: false
    type: string
    default: O2
  kernel_uname:
    required: false
    type: string
    default: "Bright-Star"
  manifest:
    required: true
    type: string
    default: OOS15

outputs:
  kernel_version:
    value: ${{ steps.save_metadata.outputs.kernel_version }}
  ksu_version:
    value: ${{ steps.save_metadata.outputs.ksu_version }}
  susfs_version:
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  image_sha256:
    value: ${{ steps.collect_stats.outputs.image_sha256 }}
  warnings:
    value: ${{ steps.collect_stats.outputs.warnings }}

runs:
  using: composite
  steps:
    # ==================== SETUP PHASE ====================
    - name: Parse config
      shell: bash
      run: |
        set -euo pipefail
        echo '${{ inputs.op_config_json }}' > /tmp/config.json
        jq -r 'to_entries[] | "OP_\(.key | ascii_upcase)=\(.value)"' /tmp/config.json >> "$GITHUB_ENV"
        
    - name: Set manifest
      shell: bash
      run: |
        set -euo pipefail
        echo "OP_MANIFEST=$OP_MANIFEST_${{ inputs.manifest }}" >> "$GITHUB_ENV"   

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        sudo apt-get -o Acquire::Retries=3 update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          git curl ca-certificates build-essential clang lld flex bison \
          libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
          libxml2-utils rsync unzip dwarves file python3 ccache
        sudo apt-get clean

    - name: Setup environment
      shell: bash
      run: |
        set -euo pipefail
        CONFIG="$OP_MODEL"
        echo "CONFIG=$CONFIG" >> "$GITHUB_ENV"
        REPO="/usr/local/bin/repo"
        if [ ! -x "$REPO" ]; then
          curl -s https://storage.googleapis.com/git-repo-downloads/repo -o "$REPO"
          chmod +x "$REPO"
        fi
        echo "REPO=$REPO" >> "$GITHUB_ENV"

    - name: Sync kernel source
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p "$CONFIG"
        cd "$CONFIG"
        if [[ "$OP_MANIFEST" == https://* ]]; then
          mkdir -p .repo/manifests
          curl --fail --location --proto '=https' "$OP_MANIFEST" -o .repo/manifests/temp_manifest.xml
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b oneplus/sm8650 -m temp_manifest.xml --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        else
          "$REPO" init -u https://github.com/OnePlusOSS/kernel_manifest.git -b "$OP_BRANCH" -m "$OP_MANIFEST" --repo-rev=v2.16 --depth=1 --no-clone-bundle --no-tags
        fi
        "$REPO" sync -c --no-clone-bundle --no-tags --optimized-fetch -j"$(nproc --all)" --fail-fast

    - name: Get kernel version
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        cd "$CONFIG_DIR/kernel_platform/common"
        
        BRANCH_LINE=$(grep '^[[:space:]]*BRANCH=' build.config.common 2>/dev/null || grep '^[[:space:]]*BRANCH=' build.config.constants 2>/dev/null || true)
        [[ -z "$BRANCH_LINE" ]] && { echo "âŒ No BRANCH found"; exit 1; }
        
        BRANCH_VALUE="${BRANCH_LINE#*=}"
        ANDROID_VERSION="${BRANCH_VALUE%-*}"
        [[ -z "$ANDROID_VERSION" ]] && { echo "âŒ Invalid Android version"; exit 1; }
        
        VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
        
        echo "$ANDROID_VERSION-$VERSION.$PATCHLEVEL.$SUBLEVEL" > "${ARTIFACTS_DIR}/${OP_MODEL}.txt"
        echo "ANDROID_VER=$ANDROID_VERSION" >> "$GITHUB_ENV"
        echo "KERNEL_VER=$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"
        echo "KERNEL_FULL_VER=$ANDROID_VERSION-$VERSION.$PATCHLEVEL.$SUBLEVEL" >> "$GITHUB_ENV"
        echo "SUSFS_KERNEL_BRANCH=gki-$ANDROID_VERSION-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2.19
      with:
        key: ${{ env.CONFIG }}-kernel-${{ env.KERNEL_FULL_VER }}
        max-size: 5G
        append-timestamp: false
        create-symlink: true

    - name: Clone dependencies
      shell: bash
      run: |
        set -euo pipefail
        ANYKERNEL_BRANCH="gki-2.0"
        [[ -z "${{ inputs.susfs_commit_hash_or_branch }}" ]] && SUSFS_BRANCH="${{ env.SUSFS_KERNEL_BRANCH }}" || SUSFS_BRANCH="${{ inputs.susfs_commit_hash_or_branch }}"
        
        git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
        git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git  
        git clone --depth=1 https://github.com/terminal-beginner/kernel_patches.git my_patches
        git clone https://gitlab.com/simonpunk/susfs4ksu.git  
        
        cd susfs4ksu
        if git rev-parse --verify "origin/$SUSFS_BRANCH" >/dev/null 2>&1 || git rev-parse --verify "$SUSFS_BRANCH" >/dev/null 2>&1; then
          git checkout "$SUSFS_BRANCH"
          echo "SUSFS_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
        else
          echo "âŒ SUSFS branch '$SUSFS_BRANCH' not found."
          exit 1
        fi

    - name: Clean ABI exports
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        rm -f common/android/abi_gki_protected_exports_* || true
        rm -f msm-kernel/android/abi_gki_protected_exports_* || true

    - name: Add Baseband Guard
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig

    - name: Add KernelSU Next
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        if [ "${{ inputs.ksun_branch }}" = "stable" ]; then
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
        else
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "${{ inputs.ksun_branch }}"
        fi
        git submodule update --init --recursive
        cd KernelSU-Next
        echo "KSUN_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Apply SUSFS patches
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cp ../../susfs4ksu/kernel_patches/50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch ./common/
        cp ../../susfs4ksu/kernel_patches/fs/* ./common/fs/
        cp ../../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
        
        cd ./KernelSU-Next
        susfs_version=$(grep '#define SUSFS_VERSION' ../common/include/linux/susfs.h | awk -F'"' '{print $2}')
        echo "SUSVER=$susfs_version" >> $GITHUB_ENV
        
        BASE_VERSION=10200
        cd ./kernel
        KSU_VERSION=$(expr $(/usr/bin/git rev-list --count HEAD) "+" $BASE_VERSION)
        sed -i "s/DKSU_VERSION=11998/DKSU_VERSION=${KSU_VERSION}/" Makefile
        cd ..
        echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
        
        case "$susfs_version" in
          "v1.5.9"|"v1.5.10"|"v1.5.11"|"v1.5.12")
            cp ../../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward < 10_enable_susfs_for_ksu.patch || true
            for file in $(find ./kernel -maxdepth 2 -name "*.rej" -printf "%f\n" | cut -d'.' -f1); do
              patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_$file.c.patch"
            done
            patch -p1 --forward < "../../../kernel_patches/next/susfs_fix_patches/$susfs_version/fix_kernel_compat.c.patch"
            ;;
          *)
            echo "âŒ Unsupported SUSFS version: $susfs_version"
            exit 1
            ;;
        esac
        patch -p1 --forward < ksun_susfs_latest.patch || true
        
        cd ../common
        if [ "${{ env.ANDROID_VER }}" = "android15" ] && [ "${{ env.KERNEL_VER }}" = "6.6" ]; then
          if ! grep -qxF '#include <trace/hooks/fs.h>' ./fs/namespace.c; then
            sed -i '/#include <trace\/hooks\/blk.h>/a #include <trace\/hooks\/fs.h>' ./fs/namespace.c
          fi
        fi
        
        patch -p1 < 50_add_susfs_in_${{ env.SUSFS_KERNEL_BRANCH }}.patch
        
        KERNEL_VERSION="${{ env.KERNEL_VER }}"
        MIN_VERSION="5.16"
        if [ "$(printf '%s\n' "$KERNEL_VERSION" "$MIN_VERSION" | sort -V | head -n1)" = "$KERNEL_VERSION" ]; then
          patch -p1 -F 3 < "../../../kernel_patches/gki_ptrace.patch"
        fi

    - name: Apply KSUN hooks
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        patch -p1 < ../../../kernel_patches/next/scope_min_manual_hooks_v1.4.patch

    - name: Configure kernel
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/gki_defconfig <<EOF
        CONFIG_KSU=y
        CONFIG_KSU_KPROBES_HOOK=n
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_NET_SCH_FQ_CODEL=y
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        EOF

    - name: Customize branding
      shell: bash
      run: |
        set -euo pipefail
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        cd "$KERNEL_PATH/common"
        mkdir -p out
        CUSTOM_LOCALVERSION="-${ANDROID_VER}-${{ inputs.kernel_uname }}"
        echo "CUSTOM_LOCALVERSION=$CUSTOM_LOCALVERSION" >> "$GITHUB_ENV"

    - name: Detect Clang
      shell: bash
      run: |
        set -euo pipefail
        KP="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        CLANG_FOUND=false
        for base in "$KP/prebuilts" "$KP/prebuilts-master"; do
          [ -d "$base/clang/host/linux-x86" ] || continue
          latest=$(ls -d "$base"/clang/host/linux-x86/clang-r*/ 2>/dev/null | sort -V | tail -n1 || true)
          if [ -n "$latest" ] && [ -x "$latest/bin/clang" ]; then
            CLANG_BIN="$latest/bin"
            CLANG_FOUND=true
          fi
        done
        if ! $CLANG_FOUND && command -v clang >/dev/null 2>&1; then
          CLANG_BIN="$(dirname "$(command -v clang)")"
          CLANG_FOUND=true
          echo "Using system clang."
        fi
        $CLANG_FOUND || { echo "âŒ No clang toolchain found"; exit 1; }
        echo "CLANG_BIN_PATH=$CLANG_BIN" >> "$GITHUB_ENV"

    - name: Build kernel
      shell: bash
      env:
        PYTHONWARNINGS: "ignore:invalid escape sequence"
      run: |
        set -euo pipefail
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        cd "$COMMON"
        : > "$COMMON/.scmversion"
        
        export PATH="${CLANG_BIN_PATH}:/usr/lib/ccache:$PATH"
        export LLVM=1 LLVM_IAS=1
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
        export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip HOSTCC=clang HOSTCXX=clang++
        export CC=ccache clang
        OUT=out
        mkdir -p "$OUT"
        
        make O="$OUT" gki_defconfig
        
        if [ -n "${CUSTOM_LOCALVERSION:-}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${CUSTOM_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion
        fi
        
        if [ "${{ inputs.optimize_level }}" = "O3" ]; then
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O3"
        else
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O2"
        fi
        
        KCFLAGS="-Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
        KCPPFLAGS="-DCONFIG_OPTIMIZE_INLINING"
        
        make O="$OUT" olddefconfig
        echo "ðŸ”¨ Starting build with $(nproc --all) threads..."
        set -o pipefail
        make -j"$(nproc --all)" O="$OUT" KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" 2>&1 | tee build.log
        
        IMG="$OUT/arch/arm64/boot/Image"
        [[ -f "$IMG" ]] || { echo "âŒ Kernel Image missing"; exit 1; }
        sha256sum "$IMG" | tee "$OUT/Image.sha256"

    - name: Collect build stats
      id: collect_stats
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        COMMON="$CONFIG_DIR/kernel_platform/common"
        OUT="$COMMON/out"
        IMG="$OUT/arch/arm64/boot/Image"
    
        WARNINGS=$(grep -i -E 'warning:' "$COMMON/build.log" | wc -l || true)
        echo "$WARNINGS" > "$OUT/warnings.txt"
        echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"
        
        if [ -f "$IMG" ]; then
          IMAGE_SHA256=$(sha256sum "$IMG" | cut -d' ' -f1)
          echo "image_sha256=$IMAGE_SHA256" >> "$GITHUB_OUTPUT"
          strings "$IMG" | grep -E 'Linux version.*#' | tail -n1 > "$OUT/kernel_version.txt"
        fi

    - name: Save kernel config
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        KERNEL_CONFIG_PATH="$CONFIG_DIR/kernel_platform/common/out/.config"
        
        [[ -f "$KERNEL_CONFIG_PATH" ]] || { echo "âš ï¸ Kernel config not found"; exit 0; }
        CONFIG_FILENAME="gki_defconfig_${{ env.KERNEL_FULL_VER }}"
        cp "$KERNEL_CONFIG_PATH" "$ARTIFACTS_DIR/$CONFIG_FILENAME"
        echo "âœ… Kernel config saved: $CONFIG_FILENAME"

    - name: Create kernel ZIP
      id: create_kernel_zip
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        IMAGE_PATH="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
        [[ -f "$IMAGE_PATH" ]] || { echo "âŒ Image not found"; exit 1; }
    
        cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
        cd "$GITHUB_WORKSPACE/AnyKernel3"
        sed -i '7 c\kernel.string=Bright-Star Kernel by terminal-beginner' anykernel.sh
        
        ZIP_NAME="AnyKernel3_${OP_MODEL}_${{ env.KERNEL_FULL_VER }}_Next_${KSUVER}_${SUSVER}.zip"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"

        ( cd "$GITHUB_WORKSPACE/AnyKernel3" && zip -r "$ARTIFACTS_DIR/$ZIP_NAME" ./* >/dev/null )
        echo "kernel_zip=$ZIP_NAME" >> "$GITHUB_OUTPUT"

    - name: Create boot image
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        IMAGE="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
        cd "$GITHUB_WORKSPACE"
        
        mkdir -p boot
        wget -q https://github.com/terminal-beginner/Bright-Star_OnePlus13R/raw/refs/heads/main/tools/boot.zip  
        unzip -q boot.zip
        
        wget -q https://github.com/magojohnji/magiskboot-linux/raw/refs/heads/main/x86_64/magiskboot  
        chmod +x ./magiskboot
        
        BOOT=$(ls *.img | head -n1)
        [[ -n "$BOOT" ]] || { echo "âŒ No boot.img found"; exit 1; }
        
        ./magiskboot unpack "$BOOT"
        mv -f "$IMAGE" kernel
        ./magiskboot repack "$BOOT"
        
        mv -f new-boot.img Bright-Star_boot.img
        cp Bright-Star_boot.img "$CONFIG_DIR/artifacts/"

    - name: Build kernel modules
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        KERNEL_PLATFORM="$CONFIG_DIR/kernel_platform"
        MSM="$KERNEL_PLATFORM/msm-kernel"
        OUT=out
        
        export PATH="${CLANG_BIN_PATH}:/usr/lib/ccache:$PATH"
        export LLVM=1
        export ARCH=arm64
        
        cd "$MSM"
        cat arch/arm64/configs/vendor/pineapple_GKI.config >> ./arch/arm64/configs/gki_defconfig
        echo "CONFIG_LTO_CLANG_THIN=y" >> ./arch/arm64/configs/gki_defconfig
        echo "CONFIG_LTO_CLANG=y" >> ./arch/arm64/configs/gki_defconfig
        
        INSTALL_MOD_PATH="$CONFIG_DIR/artifacts/msm_modules"
        make ARCH=arm64 LLVM=1 O=out gki_defconfig
        make -j$(nproc --all) ARCH=arm64 LLVM=1 O=out CC="ccache clang" modules
        make -j$(nproc --all) ARCH=arm64 LLVM=1 O=out INSTALL_MOD_PATH="$INSTALL_MOD_PATH" modules_install

    - name: Create modules ZIP
      id: create_modules_zip
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        UNIFIED_MODULES="$CONFIG_DIR/artifacts/all_modules"
        mkdir -p "$UNIFIED_MODULES"
        
        # Copy MSM modules
        if [ -d "$CONFIG_DIR/artifacts/msm_modules" ]; then
          find "$CONFIG_DIR/artifacts/msm_modules" -name "*.ko" -exec cp -f {} "$UNIFIED_MODULES/" \;
        fi
        
        # Copy common modules
        cd "$CONFIG_DIR/kernel_platform/common"
        make O=out INSTALL_MOD_PATH="$CONFIG_DIR/artifacts/common_modules" modules_install
        
        if [ -d "$CONFIG_DIR/artifacts/common_modules" ]; then
          find "$CONFIG_DIR/artifacts/common_modules" -name "*.ko" -exec cp -n {} "$UNIFIED_MODULES/" \;
        fi
        
        # Filter modules
        cd "$UNIFIED_MODULES"
        curl -L -o default_modules.txt https://raw.githubusercontent.com/terminal-beginner/kernel_patches/refs/heads/main/default_modules.txt 
        while IFS= read -r module; do
          [[ -n "$module" ]] && rm -f "$module" 2>/dev/null || true
        done < default_modules.txt
        
        MODULES_ZIP="$CONFIG_DIR/artifacts/kernel_modules_${OP_MODEL}_unified.zip"
        find . -name "*.ko" -print0 | xargs -0 zip -j "$MODULES_ZIP"
        
        echo "âœ… Modules ZIP: $(basename "$MODULES_ZIP")"
        echo "modules_zip=$(basename "$MODULES_ZIP")" >> "$GITHUB_OUTPUT"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: bright-star-${{ env.CONFIG }}
        path: ${{ env.CONFIG }}/artifacts/
